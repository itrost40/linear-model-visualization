<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Linear Model 3D Visualization</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: linear-gradient(135deg, #0b1f2c 0%, #083a4f 35%, #0f766e 100%);
      --card: rgba(255, 255, 255, 0.08);
      --card-border: rgba(255, 255, 255, 0.14);
      --accent: #f4a259;
      --accent-2: #4fd1c5;
      --text: #e8f1f2;
      --muted: #9fb4bc;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Space Grotesk', system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
    }

    .app {
      width: 100%;
      display: grid;
      grid-template-columns: 380px 1fr;
      gap: 18px;
      padding: 24px;
    }

    @media (max-width: 900px) {
      .app {
        grid-template-columns: 1fr;
      }
    }

    .panel {
      background: var(--card);
      border: 1px solid var(--card-border);
      border-radius: 18px;
      padding: 20px 20px 18px;
      backdrop-filter: blur(10px);
      box-shadow: 0 20px 50px rgba(0,0,0,0.35);
    }

    h1 {
      margin: 0 0 8px;
      font-weight: 600;
      letter-spacing: -0.02em;
    }

    .lede {
      color: var(--muted);
      margin: 0 0 18px;
      line-height: 1.5;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 999px;
      color: var(--text);
      font-size: 14px;
      margin-bottom: 12px;
    }

    .controls {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .control {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
      align-items: center;
    }

    label {
      font-weight: 500;
    }

    .value-input {
      width: 86px;
      padding: 8px 10px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 10px;
      color: var(--accent-2);
      font-weight: 600;
      text-align: right;
      outline: none;
      font-size: 15px;
      transition: border 0.15s ease, box-shadow 0.15s ease;
    }

    /* Hide number input spinners while keeping keyboard/typing support */
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type="number"] {
      -moz-appearance: textfield;
    }

    .value-input:focus {
      border-color: rgba(79, 209, 197, 0.8);
      box-shadow: 0 0 0 3px rgba(79, 209, 197, 0.2);
    }

    input[type="range"] {
      grid-column: 1 / -1;
      appearance: none;
      width: 100%;
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.14);
      outline: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--accent);
      border: 2px solid #fff;
      box-shadow: 0 6px 18px rgba(0,0,0,0.35);
      cursor: pointer;
    }

    input[type="range"]::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--accent);
      border: 2px solid #fff;
      box-shadow: 0 6px 18px rgba(0,0,0,0.35);
      cursor: pointer;
    }

    .prediction {
      margin-top: 4px;
      padding: 14px;
      border-radius: 14px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: center;
    }

    .prediction .label {
      color: var(--muted);
      font-weight: 500;
    }

    .prediction .number {
      font-size: 28px;
      font-weight: 600;
      color: var(--accent);
      letter-spacing: -0.02em;
    }

    .btn {
      appearance: none;
      border: none;
      padding: 12px 14px;
      border-radius: 12px;
      font-weight: 600;
      color: #0b1f2c;
      background: var(--accent);
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      box-shadow: 0 12px 30px rgba(244, 162, 89, 0.35);
    }

    .btn.secondary {
      background: rgba(255,255,255,0.1);
      color: var(--text);
      box-shadow: none;
      border: 1px solid rgba(255,255,255,0.18);
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 34px rgba(244, 162, 89, 0.42);
    }

    .btn:active {
      transform: translateY(0);
    }

    .button-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .scene {
      position: relative;
      overflow: hidden;
      border-radius: 18px;
      background: radial-gradient(circle at 20% 20%, rgba(255,255,255,0.06), transparent 45%),
                  radial-gradient(circle at 80% 80%, rgba(255,255,255,0.04), transparent 50%),
                  #061723;
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 20px 50px rgba(0,0,0,0.35);
      min-height: 520px;
    }

    canvas {
      width: 100%;
      height: 100%;
      display: block;
    }

    .legend {
      position: absolute;
      top: 16px;
      left: 16px;
      background: rgba(0,0,0,0.45);
      color: #e5f4f6;
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 13px;
      backdrop-filter: blur(8px);
    }

    .legend strong { color: var(--accent-2); }
  </style>
</head>
<body>
  <div class="app">
    <div class="panel">
      <div class="pill">
        <span>Linear Model</span>
        <span style="color: var(--accent)">heart.disease</span>
      </div>
      <h1>Coefficients in Motion</h1>
      <p class="lede">Slide biking and smoking percentages to see how the predicted rate of heart disease moves along the fitted plane.</p>
      <div class="controls">
        <div class="control">
          <label for="biking">Biking to Work (%)</label>
          <input class="value-input" id="bikingValue" type="number" min="0" max="40" value="15" step="0.1" />
          <input id="biking" type="range" min="0" max="40" value="15" step="0.1" />
        </div>
        <div class="control">
          <label for="smoking">Population Smoking (%)</label>
          <input class="value-input" id="smokingValue" type="number" min="0" max="40" value="15" step="0.1" />
          <input id="smoking" type="range" min="0" max="40" value="15" step="0.1" />
        </div>
        <div class="prediction">
          <div class="label">Predicted heart disease (% of people)</div>
          <div class="number" id="prediction">0.00</div>
        </div>
        <div class="button-row">
          <button class="btn" id="reset">Reset values</button>
          <button class="btn secondary" id="resetView">Reset view</button>
        </div>
      </div>
    </div>
    <div class="scene" id="scene">
      <div class="legend">
        <div><strong>x</strong>: biking %</div>
        <div><strong>y</strong>: smoking %</div>
        <div><strong>z</strong>: heart disease % (height)</div>
      </div>
    </div>
  </div>

  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.158.0/build/three.module.js"
      }
    }
  </script>
  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'https://unpkg.com/three@0.158.0/examples/jsm/controls/OrbitControls.js';

    const defaults = { biking: 15, smoking: 15 };
    const viewDefaults = {
      position: new THREE.Vector3(60, 60, 48),
      target: new THREE.Vector3(20, 20, 14)
    };
    const eq = (biking, smoking) => 14.9847 + (-0.2001 * biking) + (0.1783 * smoking);

    const sceneEl = document.getElementById('scene');
    const bikingSlider = document.getElementById('biking');
    const smokingSlider = document.getElementById('smoking');
    const bikingValue = document.getElementById('bikingValue');
    const smokingValue = document.getElementById('smokingValue');
    const predictionEl = document.getElementById('prediction');
    const resetBtn = document.getElementById('reset');
    const resetViewBtn = document.getElementById('resetView');

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x061723);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(sceneEl.clientWidth, sceneEl.clientHeight);
    sceneEl.appendChild(renderer.domElement);

    const camera = new THREE.PerspectiveCamera(50, sceneEl.clientWidth / sceneEl.clientHeight, 0.1, 500);
    camera.up.set(0, 0, 1); // treat heart disease (z) as up
    camera.position.copy(viewDefaults.position);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.target.copy(viewDefaults.target);
    controls.update();
    controls.saveState();

    const ambient = new THREE.AmbientLight(0xc7d5e0, 0.5);
    scene.add(ambient);
    const dir = new THREE.DirectionalLight(0xffffff, 0.9);
    dir.position.set(30, 50, 20);
    scene.add(dir);

    const axes = new THREE.AxesHelper(45);
    axes.position.set(0, 0, 0);
    scene.add(axes);

    // Small canvas-based labels to mark axes directions
    function createLabel(text, color = '#e8f1f2') {
      const dpr = window.devicePixelRatio || 1;
      const baseHeight = 320;
      const font = 'bold 72px Space Grotesk, sans-serif';

      // Measure text to set canvas width with generous padding to avoid clipping
      const measureCanvas = document.createElement('canvas');
      const measureCtx = measureCanvas.getContext('2d');
      measureCtx.font = font;
      const metrics = measureCtx.measureText(text);
      const padding = 120;
      const baseWidth = Math.max(760, Math.ceil(metrics.width + padding * 2));

      const c = document.createElement('canvas');
      c.width = baseWidth * dpr;
      c.height = baseHeight * dpr;
      const ctx = c.getContext('2d');
      ctx.scale(dpr, dpr);
      ctx.clearRect(0, 0, baseWidth, baseHeight);

      ctx.fillStyle = color;
      ctx.font = font;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.shadowColor = 'rgba(0,0,0,0.45)';
      ctx.shadowBlur = 8;
      ctx.fillText(text, baseWidth / 2, baseHeight / 2);

      const texture = new THREE.CanvasTexture(c);
      texture.anisotropy = renderer.capabilities.getMaxAnisotropy();
      const material = new THREE.SpriteMaterial({
        map: texture,
        transparent: true,
        depthWrite: false,
        depthTest: false
      });
      const sprite = new THREE.Sprite(material);
      sprite.renderOrder = 10; // draw on top of opaque geometry
      sprite.scale.set(baseWidth / 45, baseHeight / 40, 1);
      return sprite;
    }

    const labelX = createLabel('Biking % (x)', '#4fd1c5');
    labelX.position.set(44, 0.5, 0);
    scene.add(labelX);

    const labelY = createLabel('Smoking % (y)', '#f4a259');
    labelY.position.set(0, 44, 0.5);
    scene.add(labelY);

    const labelZ = createLabel('Heart Disease % (z)', '#c2e6ff');
    labelZ.position.set(0, 0.5, 44);
    scene.add(labelZ);

    const grid = new THREE.GridHelper(60, 12, 0x2c5f72, 0x13303f);
    grid.rotation.x = Math.PI / 2; // align to x/y with z up
    grid.position.set(20, 20, -0.001);
    scene.add(grid);

    // Plane based on equation z = 14.9847 - 0.2001x + 0.1783y
    const range = { min: 0, max: 40, step: 2 };
    const planeGeom = new THREE.BufferGeometry();
    const verts = [];
    const colors = [];
    const colorA = new THREE.Color('#4fd1c5');
    const colorB = new THREE.Color('#f4a259');

    for (let y = range.min; y <= range.max; y += range.step) {
      for (let x = range.min; x <= range.max; x += range.step) {
        const z = eq(x, y); // heart disease height
        verts.push(x, y, z);
        const t = (z - 5) / 15;
        const c = colorA.clone().lerp(colorB, THREE.MathUtils.clamp(t, 0, 1));
        colors.push(c.r, c.g, c.b);
      }
    }

    const segments = (range.max - range.min) / range.step + 1;
    const indices = [];
    for (let j = 0; j < segments - 1; j++) {
      for (let i = 0; i < segments - 1; i++) {
        const a = j * segments + i;
        const b = a + 1;
        const c = a + segments;
        const d = c + 1;
        indices.push(a, b, d, a, d, c);
      }
    }

    planeGeom.setAttribute('position', new THREE.Float32BufferAttribute(verts, 3));
    planeGeom.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
    planeGeom.setIndex(indices);
    planeGeom.computeVertexNormals();

    const planeMat = new THREE.MeshStandardMaterial({
      vertexColors: true,
      side: THREE.DoubleSide,
      transparent: true,
      opacity: 0.9,
      roughness: 0.2,
      metalness: 0.1
    });
    const planeMesh = new THREE.Mesh(planeGeom, planeMat);
    scene.add(planeMesh);

    const pointGeom = new THREE.SphereGeometry(0.9, 24, 24);
    const pointMat = new THREE.MeshStandardMaterial({ color: 0xf4a259, emissive: 0x402400, emissiveIntensity: 0.55 });
    const point = new THREE.Mesh(pointGeom, pointMat);
    scene.add(point);

    const stemGeom = new THREE.CylinderGeometry(0.15, 0.15, 1, 12, 1, true);
    const stemMat = new THREE.MeshBasicMaterial({ color: 0xf4a259, transparent: true, opacity: 0.35 });
    const stem = new THREE.Mesh(stemGeom, stemMat);
    stem.rotation.x = Math.PI / 2; // orient cylinder along z
    stem.visible = false;
    scene.add(stem);

    function createPointLabel() {
      const dpr = window.devicePixelRatio || 1;
      const width = 820;
      const height = 260;
      const canvas = document.createElement('canvas');
      canvas.width = width * dpr;
      canvas.height = height * dpr;
      const ctx = canvas.getContext('2d');
      ctx.scale(dpr, dpr);
      const texture = new THREE.CanvasTexture(canvas);
      texture.anisotropy = renderer.capabilities.getMaxAnisotropy();
      const material = new THREE.SpriteMaterial({
        map: texture,
        transparent: true,
        depthWrite: false,
        depthTest: false
      });
      const sprite = new THREE.Sprite(material);
      sprite.renderOrder = 15; // above other labels/geometry
      sprite.scale.set(width / 55, height / 55, 1);

      function update(text) {
        ctx.clearRect(0, 0, width, height);
        ctx.font = 'bold 64px Space Grotesk, sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.lineWidth = 8;
        ctx.strokeStyle = 'rgba(0,0,0,0.6)';
        ctx.strokeText(text, width / 2, height / 2);
        ctx.shadowColor = 'rgba(0,0,0,0.45)';
        ctx.shadowBlur = 10;
        ctx.fillStyle = '#f4a259';
        ctx.fillText(text, width / 2, height / 2);
        texture.needsUpdate = true;
      }

      return { sprite, update };
    }

    const pointLabel = createPointLabel();
    scene.add(pointLabel.sprite);

    function clamp(val, min, max) {
      return Math.min(Math.max(val, min), max);
    }

    function updatePoint() {
      const biking = parseFloat(bikingSlider.value);
      const smoking = parseFloat(smokingSlider.value);
      const predicted = eq(biking, smoking);

      bikingValue.value = biking.toFixed(1);
      smokingValue.value = smoking.toFixed(1);
      predictionEl.textContent = predicted.toFixed(2);

      point.position.set(biking, smoking, predicted);
      stem.visible = true;
      stem.position.set(biking, smoking, predicted / 2);
      stem.scale.set(1, predicted, 1);

      pointLabel.update(`Heart disease: ${predicted.toFixed(2)}%`);
      pointLabel.sprite.position.set(biking, smoking, predicted + 3);
    }

    function reset() {
      bikingSlider.value = defaults.biking;
      smokingSlider.value = defaults.smoking;
      bikingValue.value = defaults.biking.toFixed(1);
      smokingValue.value = defaults.smoking.toFixed(1);
      updatePoint();
    }

    bikingSlider.addEventListener('input', updatePoint);
    smokingSlider.addEventListener('input', updatePoint);

    function wireNumberInput(inputEl, sliderEl) {
      const min = parseFloat(sliderEl.min);
      const max = parseFloat(sliderEl.max);

      function commit() {
        const raw = parseFloat(inputEl.value);
        const fallback = parseFloat(sliderEl.value);
        const v = Number.isFinite(raw) ? clamp(raw, min, max) : fallback;
        sliderEl.value = v;
        inputEl.value = v.toFixed(1);
        updatePoint();
      }

      inputEl.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          commit();
          inputEl.blur();
        }
      });

      inputEl.addEventListener('blur', commit);
    }

    wireNumberInput(bikingValue, bikingSlider);
    wireNumberInput(smokingValue, smokingSlider);

    resetBtn.addEventListener('click', reset);
    function resetView() {
      camera.position.copy(viewDefaults.position);
      controls.target.copy(viewDefaults.target);
      controls.update();
    }
    resetViewBtn.addEventListener('click', resetView);

    function resize() {
      const { clientWidth, clientHeight } = sceneEl;
      renderer.setSize(clientWidth, clientHeight);
      camera.aspect = clientWidth / clientHeight;
      camera.updateProjectionMatrix();
    }

    window.addEventListener('resize', resize);

    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }

    reset();
    resize();
    animate();
  </script>
</body>
</html>
